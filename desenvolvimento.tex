%---------- Segundo Capitulo ----------
\chapter{Desenvolvimento} \label{chap:desenv}

Este capítulo apresenta o desenvolvimento do projeto, detalhando cada parte do sistema desenvolvido. A descrição apresentada a seguir referencia os conceitos apresentados no capítulo \ref{chap:fundteor}. A figura \ref{fig:desenv_overview} apresenta uma visão geral do sistema desenvolvido.

\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{./figs/visao_geral.jpg}
	\caption{Visão geral do sistema desenvolvido.}
	\fonte{Autoria própria}
	\label{fig:desenv_overview}
\end{figure}

O capitulo divide-se em sete seções. As primeiras seis seções apresentam com detalhes os blocos da figura \ref{fig:desenv_overview}: A seção \ref{sec:desenv_seg1} e a seção \ref{sec:desenv_seg2} mostram como os conceitos da seção \ref{sec:segmentacao} foram aplicados para segmentar a imagem capturada. A seção \ref{sec:desenv_desc1} e a seção \ref{sec:desenv_desc2} apresentam como os descritores de \emph{fourier} e as propriedades estudados na seção \ref{subsec:propriedades} foram aplicados para formar um descritor para as imagens. As seções \ref{sec:desenv_class1} e \ref{sec:desenv_class2} apresentam como os descritores foram utilizados para classificar e determinar o ângulo das imagens. Finalmente, na seção \ref{sec:desenv_consideracoes}, algumas considerações sobre o desenvolvimento do projeto são apresentadas.


\section{Segmentação: etapa 1} \label{sec:desenv_seg1}

A primeira etapa da segmentação consiste em uma série de limiarizações e filtros para localizar a região de interesse na imagem. A saída da primeira etapa é uma imagem binária contendo a região de interesse. O processo da primeira etapa pode ser visto na figura \ref{fig:desenv_seg1}.

O processo inicia pela subtração da imagem RGB de fundo da imagem RGB com o objeto. Como resultado tem-se uma imagem RGB contendo as diferenças inseridas pelo objeto na imagem. Para não perder informações intrínsecas da imagem RGB no processo de conversão para escala de cinza dividem-se os canais R, G e B da imagem. Cada canal é processado separadamente. Primeiramente os canais são limiarizados utilizando o método global de \emph{Otsu}, discutido na seção \ref{sub:fundteor_limiarizacao}. Em seguida os canais são submetidos à operação morfológica de fechamento, vista na seção \ref{sub:fundteor_op_morfologicas}. A operação de fechamento é aplicado para reduzir o ruido do tipo pimenta (pixeis pretos espalhados aleatoriamente pela imagem). Na sequencia os três canais processados separadamente são unidos através da operação lógica OU para formar uma única imagem. Finalmente a maior região conexa da imagem é selecionada para ser a região de interesse.

Embora não se possa ver visualmente nenhum progresso significativo em alguns passos da sequencia de imagens da figura \ref{fig:desenv_seg1}, a primeira etapa da segmentação necessita de todos eles. Todos os passos apresentados anteriormente garantem a robustez do sistema, fornecendo a região de interesse para a etapa seguinte.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{./figs/segmentacao_1.jpg}
	\caption{Primeira etapa da segmentação.}
	\fonte{Autoria própria}
	\label{fig:desenv_seg1}
\end{figure}


\section{Segmentação: etapa 2} \label{sec:desenv_seg2}

A segunda etapa da segmentação é responsável por normalizar a imagem. Esta etapa recebe como entrada a região de interesse e apresenta como saída duas opções de normalização, além de um autovetor e seu oposto. O processo pode ser visto na figura \ref{fig:desenv_seg2}.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\textwidth]{./figs/segmentacao_2.jpg}
	\caption{Segunda etapa da segmentação.}
	\fonte{Autoria própria}
	\label{fig:desenv_seg2}
\end{figure}

A região de interesse obtida da primeira etapa de segmentação é esqueletonizada e podada pelos processos descritos na seção \ref{sub:fundteor_esqueletonizacao}. Em seguida o processo de normalização da seção \ref{sub:fundteor_normalizacao} é aplicado.

Como dito na seção \ref{sub:fundteor_normalizacao}, o autovetor associado ao maior autovalor da matriz de covariâncias aponta na direção de maior variação dos dados. Porém o autovetor não aponta no sentido de maior variação dos dados. Empiricamente percebe-se que o autovetor aponta sempre no sentido positivo dos eixos da imagem. Esse comportamento leva a duas possíveis normalizações para cada imagem. A normalização obtida utilizando o autovetor $A$ e a normalização pelo oposto do autovetor, $A'=-A$. 

Essas duas opções de normalização são então apresentadas a etapa seguinte juntamente com os respectivos autovetores.


\section{Descrição: etapa 1} \label{sec:desenv_desc1}

Essa etapa de descrição é responsável por gerar um descritor para a imagem normalizada utilizando o autovetor $A$ (chamada mais adiante de imagem pré-normalizada). A imagem normalizada utilizando o autovetor $A'$ não é utilizada. A figura \ref{fig:desenv_desc1} resume o processo desta etapa.

O descritor é composto por 20 descritores de \emph{fourier}, $d1,d2,...,d20$, concatenados com 9 propriedades básicas da imagem, $p1,p2,...,p9$. A tabela \ref{tab:descritores-etapa1} detalha o descritor gerado.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\textwidth]{./figs/descricao_1.jpg}
	\caption{Primeira etapa da descrição.}
	\fonte{Autoria própria}
	\label{fig:desenv_desc1}
\end{figure}

\begin{table}[htb!]
	\centering
	\caption[Descritor para primeira etapa]{Descritor para primeira etapa.}		
	\begin{tabular}[H]{ l l l l }
	  \hline
	  Descritor & Descrição \\
	  \hline
	  $d1 ... d20$ & 20 descritores de \emph{fourier} \\
	  $p1$ & Área \\
	  $p2$ & Área convexa \\
	  $p3$ & Excentricidade \\
	  $p4$ & Número de Euler \\
	  $p5$ & Extensão \\
	  $p6$ & Área preenchida \\
	  $p7$ & Tamanho do eixo principal \\
	  $p8$ & Tamanho do eixo secundário \\
	  $p9$ & Solidez \\
	  \hline  	
	\end{tabular}
	\fonte{Autoria própria}
	\label{tab:descritores-etapa1}
\end{table}


\section{Classificação} \label{sec:desenv_class1}

A função da etapa de classificação é tomar como entrada o descritor da imagem pré-normalizada e fornecer como saída a classe a qual o objeto da imagem pertence. Além disso é responsável por dizer qual a normalização correta para a imagem. Ou seja, se a imagem normalizada corretamente utiliza o autovetor $A$ ou o oposto $A'$. Esse processo é mostrado na figura \ref{fig:desenv_class1}.

%TODO: por que foi utilizada rede neural e não outra coisa como SVM

Para essa tarefa foi utilizada uma rede neural de duas camadas, 29 entradas e $2N$ saídas. Onde $N$ é o número de classes a serem identificadas pelo sistema. A primeira camada possui 20 \emph{perceptrons} e a camada de saída possui $2N$ perceptrons.
O número de \emph{perceptrons} na primeira camada foi escolhido empiricamente. O número de saídas é $2N$ pois a rede deve ser capaz de identificar imagens normalizadas pelo autovetor $A$ e imagens normalizadas pelo oposto $A'$. A função de ativação para as duas camadas é a função sigmoide vista na seção \ref{subsec:fundteor_redes_neurais}. A função sigmoide é uma boa escolha para redes de classificação pois possui uma transição rápida entre -1 e 1 para entradas de $-\infty$ a $+\infty$ \cite{MATHWORKS-HELP-3}.

Para formar o conjunto de treinamento da rede é necessário que se obtenha amostras de imagens com as respectivas classes.  Em seguida deve-se executar todos os passos até obter as duas possibilidades de normalização de cada imagem, e os descritores tomando a normalização dada pelo autovetor $A$. O descritor é então fornecido como entrada da rede e a saída da rede é dada pelo autovetor que leva a normalização correta da imagem. Por exemplo, se a normalização correta da classe $n$ é dada pelo autovetor $A$, a posição $2n$ da saída é um e o restante zero. Se a normalização correta é dada pelo oposto do autovetor, $A'$, então a posição "2n+1" é um e o restante zero. Esse último passo necessita ser executado manualmente para que se possa "ensinar" a rede qual a normalização correta para cada classe.

A rede é treinada utilizando um algoritmo de \emph{back propagation} conforme visto na seção \ref{subsec:fundteor_redes_neurais}. O algoritmo utilizado para esta rede em específico utiliza o método chamado \emph{Bayesian regularization}. O método em questão não é aprofundado aqui. A escolha foi baseada na documentação presente em \cite{MATHWORKS-HELP-4} que afirma que redes treinadas utilizando essa otimização possuem boa capacidade de generalização.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\textwidth]{./figs/classificacao_1.jpg}
	\caption{Etapa de classificação.}
	\fonte{Autoria própria}
	\label{fig:desenv_class1}
\end{figure}


\section{Descrição: etapa 2} \label{sec:desenv_desc2}

A segunda etapa da descrição recebe como entrada a imagem normalizada pelo autovetor correto. A função desta etapa é gerar um descritor para a imagem normalizada, que auxiliará na etapa de estimativa do ângulo do objeto.

Tanto esta etapa, quanto a estimativa de angulo descrita na próxima seção, seriam desnecessárias em ambientes ideais. Veja por exemplo as imagens da figura \ref{fig:desenv_desc3}. Todas as imagens foram obtidas para um mesmo objeto, sujeito às mesmas condições gerais, mas em rotações diferentes. Mudanças pequenas, como ruído ou pequenas diferenças na iluminação, influenciaram a direção do autovetor calculado produzindo resultados diferentes.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\textwidth]{./figs/normalizacoes_A.png}
	\caption{Imagens normalizadas para diferentes entradas do mesmo objeto.}
	\fonte{Autoria própria}
	\label{fig:desenv_desc3}
\end{figure}

A diferença entre o autovetor calculado para cada caso é tratada na etapa de estimativa de ângulo que recebe como entrada o descritor calculado aqui. O descritor portanto deve conter informações relacionadas à posição do objeto na imagem normalizada. Utilizou-se para essa tarefa um descritor contendo 10 descritores de \emph{fourier} juntamente com as coordenadas do centroide da imagem. O descritor pode ser visto na figura \ref{fig:desenv_desc2}. 

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\textwidth]{./figs/descricao_2.jpg}
	\caption{Segunda etapa da descrição.}
	\fonte{Autoria própria}
	\label{fig:desenv_desc2}
\end{figure}

\section{Estimativa de ângulo} \label{sec:desenv_class2}

Finalmente a última etapa recebe como entrada um descritor da imagem normalizada, a classe a qual pertence o objeto e o autovetor utilizado na normalização. O objetivo dessa etapa é fornecer o ângulo de rotação do objeto na imagem.

Considere a figura \ref{fig:desenv_class3}. Os eixos $x,y$ são as coordenadas da imagem. O eixo $x'$ é o eixo que foi assumido como sendo o zero para o objeto da figura. $A$ é o autovetor calculado na etapa de normalização. Pela figura tem-se então a equação \ref{eq:desenv_beta}.

\begin{equation}
\beta = \alpha - k
\label{eq:desenv_beta}
\end{equation}

Onde:

\begin{itemize}
\item $\beta$ é o ângulo entre as coordenadas da imagem e o zero do objeto. Ou seja, o valor que se deseja obter;
\item $\alpha$ é o ângulo dado pelo autovetor;
\item $k$ é a diferença entre o angulo do autovetor e o zero do objeto. Este valor pode variar de normalização para normalização, conforme visto na figura \ref{fig:desenv_desc3}.
\end{itemize}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\textwidth]{./figs/classificacao_3.jpg}
	\caption{Representação do autovetor (em vermelho), dos eixos da imagem (em amarelo) e do eixo do objeto (em azul).}
	\fonte{Autoria própria}
	\label{fig:desenv_class3}
\end{figure}

É necessário portanto determinar o valor de $k$ para cada imagem normalizada. Utilizou-se para essa tarefa uma segunda rede neural. Essa rede recebe como entrada um descritor da imagem normalizada e informa na saída o valor de $k$. Para cada classe é gerada uma rede diferente, visto que as variações são diferentes de classe para classe. Após obter o valor $k$ da rede basta utilizar a equação \ref{eq:desenv_beta} para determinar o angulo $\beta$ do objeto. Esse processo está resumido na figura \ref{fig:desenv_class2}.

%TODO: por que foi utilizada rede neural e não outra coisa como SVM

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\textwidth]{./figs/classificacao_2.jpg}
	\caption{Segunda etapa da classificação.}
	\fonte{Autoria própria}
	\label{fig:desenv_class2}
\end{figure}

A rede utilizada nessa etapa possui duas camadas, 12 entradas e uma saída. A primeira camada é formada por 7 \emph{perceptrons}. A melhor quantidade de perceptrons foi determinada empiricamente. A saída da rede possui um único perceptron pois a única saída da rede é o valor de $k$. A função de ativação da primeira camada da rede é a sigmoide pois permite o aprendizado de não linearidades. A segunda camada da rede possui uma função linear, $y=x$, favorecendo uma ampla faixa de valores de saída para $k$ \cite{MATHWORKS-HELP-3}.

Para o processo de treinamento da rede são utilizadas as mesmas amostras que foram utilizadas para o treinamento da rede responsável pela classificação do objeto. Em seguida são executadas as etapas descritas nas seções anteriores até a obtenção do descritor de entrada da rede. Além disso é necessário o conhecimento do ângulo em que o objeto se encontra para o cálculo de $k$ pela equação \ref{eq:desenv_beta}. Uma vez tendo o valor de $k$ e o descritor de entrada é possível treinar a rede.

A rede é treinada utilizando um algoritmo de \emph{back propagation} conforme visto na seção \ref{subsec:fundteor_redes_neurais}. O algoritmo utilizado para esta rede em específico utiliza a otimização de \emph{Levenberg-Marquardt}. A escolha foi baseada na documentação presente em \cite{MATHWORKS-HELP-5} que afirma que esta deveria ser a primeira opção de treinamento para qualquer rede devido a alta velocidade de convergência no treinamento.

\section{Considerações} \label{sec:desenv_consideracoes}
% fechamento com relacao aos objetivos do capitulo
% deve ser parte da conclusao final
% podem aparecer consideracoes pessoais

% foi desenvolvido um sistema robusto
% a versão apresentada não é a primeira desenvolvida
% foram implementados algoritmos de crescimento de regiao mas nao agregaram


Este capítulo apresenta o desenvolvimento do projeto, detalhando cada parte do sistema desenvolvido. A descrição apresentada a seguir referencia os conceitos apresentados no capítulo \ref{chap:fundteor}. A figura \ref{fig:desenv_overview} apresenta uma visão geral do sistema desenvolvido.

\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{./figs/visao_geral.jpg}
	\caption{Visão geral do sistema desenvolvido.}
	\fonte{Autoria própria}
	\label{fig:desenv_overview}
\end{figure}

O capitulo divide-se em sete seções. As primeiras seis seções apresentam com detalhes os blocos da figura \ref{fig:desenv_overview}: A seção \ref{sec:desenv_seg1} e a seção \ref{sec:desenv_seg2} mostram como os conceitos da seção \ref{sec:segmentacao} foram aplicados para segmentar a imagem capturada. A seção \ref{sec:desenv_desc1} e a seção \ref{sec:desenv_desc2} apresentam como os descritores de \emph{fourier} e as propriedades estudados na seção \ref{subsec:propriedades} foram aplicados para formar um descritor para as imagens. As seções \ref{sec:desenv_class1} e \ref{sec:desenv_class2} apresentam como os descritores foram utilizados para classificar e determinar o ângulo das imagens. Finalmente, na seção \ref{sec:desenv_consideracoes}, algumas considerações sobre o desenvolvimento do projeto são apresentadas.
